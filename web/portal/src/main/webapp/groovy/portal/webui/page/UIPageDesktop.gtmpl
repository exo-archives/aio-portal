<%
  import org.exoplatform.portal.webui.application.UIPortlet ;
  import org.exoplatform.web.application.JavascriptManager ;
  import org.exoplatform.portal.config.model.PageNavigation ;
  import org.exoplatform.portal.config.model.PageNode ;
  def rcontext = _ctx.getRequestContext() ;
  JavascriptManager jsmanager = rcontext.getJavascriptManager();
  
  jsmanager.importJavascript('eXo.desktop.UIDesktop');
  jsmanager.importJavascript('eXo.webui.UIPopupSelectCategory') ;
  jsmanager.importJavascript('eXo.desktop.UIWindow') ;
  jsmanager.importJavascript('eXo.webui.UIRightClickPopupMenu') ;
  
  jsmanager.addCustomizedOnLoadScript('eXo.desktop.UIDockbar.initNav();') ;
  
  String docBase =  rcontext.getRequestContextPath() ;
  String comId = uicomponent.getId();
  boolean modifiable = uicomponent.isModifiable();
  
    void renderSinglePageNode(PageNavigation nav, PageNode node) {
    String  href = uicomponent.event("ChangePage",  nav.getId() + "::" + node.getUri()) ;
    String icon = node.getIcon();
    if(icon == null) icon = "DefaultPageIcon";
    print """
      <div class="MenuItem">
        <div class="LabelItem">
          <div class="Icon $icon"  style="padding-left: 18px">
            <div class="LabelText"><a href="#" onclick="$href">$node.resolvedLabel</a></div>
          </div>
        </div>
      </div>
    """ ;
  }
  
  void renderPageNode(PageNavigation nav, PageNode node) {
     String  href = uicomponent.event("ChangePage",   nav.getId() + "::" +  node.getUri()) ;
     String icon = node.getIcon();
     String scrollUpTitle = _ctx.appRes("UIExoStart.tooltip.scrollUp") ;
  	 String scrollDownTitle = _ctx.appRes("UIExoStart.tooltip.scrollDown") ;
     if(icon == null) icon = "DefaultPageIcon";
     print """
      <div class="MenuItem">
        <div class="LabelItem">
          <div class="Icon $icon" style="padding-left: 18px"> 
            <div class="BlackArrowIcon">
              <div class="LabelText "><a href="#" onclick="$href">$node.resolvedLabel</a></div>
            </div>
          </div>
        </div>
        <div class="MenuItemContainer">
          <div class="StartMenuDecorator">
            <div class="StartMenuTL">
              <div class="StartMenuTR">
                <div class="StartMenuTC"><span></span></div>
              </div>
            </div>
            <div class="StartMenuML">
              <div class="StartMenuMR">
                <div class="StartMenuBG" style="padding-bottom: 6px">
						      <div class="TopNavigator" style="display: none;" title="$scrollUpTitle">
						      		<div class="UpNavigatorIcon"><span></span></div>
						      </div>
									<div class="BlockMenu" style="position: relative;">
						      <div class="MenuContainer">          
						      """ ;
						      for(child in node.getChildren()) {
						        if(child.getChildren() != null && child.getChildren().size() > 0) renderPageNode(nav, child) ;
						        else renderSinglePageNode(nav, child) ;
						      }
						      print """
						      </div>
						      </div>
						      <div class="BottomNavigator" style="display: none;" title="$scrollDownTitle">
						      		<div class="DownNavigatorIcon"><span></span></div>
						      </div>
                </div>
              </div>
            </div>
            <div class="StartMenuBL">
              <div class="StartMenuBR">
              <div class="StartMenuBC"><span></span></div>
              </div>
            </div>             
          </div>  
        </div>
      </div>
    """ ;
  }
  
  void renderPageNavigation(PageNavigation navigation) {
  	nodes = navigation.getNodes() ;
  	if(nodes.size() < 1) return ;
		String navTitle = _ctx.appRes("UIPageNavigation.label.titleBar") ;
		navTitle = navTitle.replace("{0}", navigation.ownerId);
    print """
    	<div class="PageNavigationBlock">
	      <div class="DecoratorBlock">
	      	<div class="PageOwnerContainer">
	        	<div class="TitleBar">$navTitle </div>
				    """ ;
				    for(node in nodes) {
				      if(node.getChildren() != null && node.getChildren().size() > 0) {
				        renderPageNode(navigation, node) ;
				      }
				      else renderSinglePageNode(navigation, node) ;
				    }
				    print """
    			</div>
    		</div>
      </div>
    """ ;    
  }
  
  void renderNavigations() {
    String label = _ctx.appRes(uicomponent.getId() + ".item.PageNavigation") ;
    String scrollUpTitle = _ctx.appRes("UIExoStart.tooltip.scrollUp") ;
  	String scrollDownTitle = _ctx.appRes("UIExoStart.tooltip.scrollDown") ;
    navigations = uicomponent.getNavigations() ;
   	//if (navigations != null && navigations.size() > 0 && navigations.get(0).getNodes().size() > 0) {
   	if (navigations != null && navigations.size() > 0) {
       	print """ 
        <div class="MenuItemContainer NavigationContainer" style="position: absolute; top: -450px;">
          <div class="StartMenuDecorator">
            <div class="StartMenuTL">
              <div class="StartMenuTR">
                <div class="StartMenuTC"><span></span></div>
              </div>
            </div>
            <div class="StartMenuML">
              <div class="StartMenuMR">
                <div class="StartMenuBG" style="padding: 5px 0px;">
					        <div class="TopNavigator" style="display: none;" title="$scrollUpTitle">
					        	<div class="UpNavigatorIcon"><span></span></div>
					        </div>
									<div class="BlockMenu" style="position: relative;">
					      	<div class="MenuContainer"> 
					      	""" ;
						      for(navigation in navigations) {
						        renderPageNavigation(navigation) ;
						      }
					      	print """
					      	</div>
					      	</div>
					      	<div class="BottomNavigator" style="display: none;" title="$scrollDownTitle">
					      		<div class="DownNavigatorIcon"><span></span></div>
					      	</div>
                </div>
              </div>
            </div>
            <div class="StartMenuBL">
              <div class="StartMenuBR">
              <div class="StartMenuBC"><span></span></div>
              </div>
            </div>
          </div>  
        </div>
    		""" ;
    }
  }
  
%>


<div class="UIPage" id="UIPage-${uicomponent.id}">
  <div class="META-DATA-BLOCK" style="display: none">
    <div class="id">$uicomponent.id</div>
    <div class="title"><%=_ctx.appRes("UIPageDesktop.title.PortalPage")%></div>
    <div class="description"><%=_ctx.appRes("UIPageDesktop.label.pagebody")%></div>
  </div>
  <div class="CONTROL-PAGE CONTROL-BLOCK" style="display: none"><span></span></div>

  <div class="LAYOUT-PAGE" style="display: none;">
    <div class="PageLayoutDecorator">
    
      <%/*Begin Top Decorator*/%>
      <div class="TopLeftPage">
        <div class="TopRightPage">
          <div class="TopCenterPage">
            <div class="PageContent"><%=_ctx.appRes("UIPageDesktop.label.PageContent")%></div>
          </div>
        </div>
      </div>
      
      <%/*Begin Middle Decorator*/%>
      <div class="MiddleLeftPage">
        <div class="MiddleRightPage">
          <div class="MiddlePageBG">
						<div class="FixBug"><span></span></div>
					</div>
        </div>
      </div>
      
      <%/*Begin Bottom Decorator*/%>
      <div class="BottomLeftPage">
        <div class="BottomRightPage">
          <div class="BottomCenterPage">
          	<div class="FixBug"><span></span></div>
					</div>
        </div>
      </div>
        
    </div>    
  </div>
  
  <div class="VIEW-PAGE">
    <div id="UIPage">
      <div class="UIPageDesktop" id="UIPageDesktop">
        <%int x = 15; y = 15 %>
        <%for(uiChild in uicomponent.getChildren()) {
            if(!(uiChild instanceof UIPortlet)) {
              uicomponent.renderUIComponent(uiChild);
              continue;
            }
            
            String  popupId = uiChild.getId() ;
            String title = uiChild.getTitle() ;
            if(title == null || title.trim().length() < 1) {
              title = popupId;
              uiChild.setTitle(title);
            }
            
            //String removeChildAction = uicomponent.event("RemoveChild", popupId) ;
        
            uiChild.setShowInfoBar(true);
            uiChild.setPortletStyle("Window");
	          uicomponent.renderUIComponent(uiChild);
	          
	          String posX = uiChild.getProperties().get("locationX");
	          String posY = uiChild.getProperties().get("locationY");
	          
	          //System.out.println("\n\n\n\n\n\n\n\n GET POSX: "+posX+" \n GET POSY: "+posY+"\n\n\n\n\n\n\n\n");
	          
	          if(posX == null) posX = (String)x ;
	          if(posY == null) posY = (String)y ;
	          
            jsmanager.addJavascript("eXo.desktop.UIWindow.init('UIWindow-${popupId}', true, ${posX}, ${posY});") ;
        %>
        <%  x += 10; y += 20 ;%>
        <%}%>

        <%//String containerMouseOver = "eXo.desktop.UIDockbar.containerMouseOver();" ;%>
        <div class="UIDockBar" id="UIDockBar" onmouseover="eXo.desktop.UIDockbar.startDockBarEvt(event);">
        	<div id="DockNavigation" class="UIExoStart" style="position: absolute; display: none; width: 0px;">
        		<div class="StartMenuContainer">
	          		<% renderNavigations() ; %>
	          </div>
          </div>	
			<div class="UIRightClickPopupMenu" id="DockbarContextMenu" onmousedown="event.cancelBubble = true;">
			  <div class="UIContextMenuContainer" >
					<div class="TopLeftRightClickPopupMenu">
						<div class="TopRightRightClickPopupMenu">
							<div class="TopCenterRightClickPopupMenu"><span></span></div>
						</div>
					</div>
					<div class="MiddleLeftRightClickPopupMenu">
						<div class="MiddleRightRightClickPopupMenu">
						  <div class="UIRightPopupMenuContainer">
						   	<a class="MenuItem" href="javascript:eXo.desktop.UIDesktop.removeApp('<%=uicomponent.url("RemoveChild", "_objectid_")%>')" onclick="return eXo.webui.UIRightClickPopupMenu.prepareObjectId(event, this);" > 	
									<div class="ItemIcon CloseDockBarIcon"><%=_ctx.appRes("UIPageDesktop.action.Close")%></div>
							 	</a>
							  <div class="RightClickCustomItem"><%=_ctx.appRes("UIPageDesktop.action.action.Open")%></div>
							</div>
						</div>
					</div>
					<div class="BottomLeftRightClickPopupMenu">
						<div class="BottomRightRightClickPopupMenu">
							<div class="BottomCenterRightClickPopupMenu">
								<div class="ClickCenterBottom"><span></span></div>
							</div>
						</div>
					</div>
				</div>
			</div>
          <div class="DockbarLeft">
            <div class="DockbarRight">
              <div class="DockbarCenter" id="DockbarCenter">
              	
                <div class="IconContainer" id="IconContainer" style="text-align: center;">
                  <img id="FixBug" src="/eXoResources/skin/sharedImages/Debug1x32.gif" />
                  
  	                  <img class="Icon" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/NavigationIcon.png"  alt="/eXoResources/skin/sharedImages/Blank.gif" title=""
	                       id="UIAddApplicationIcon"
	                       onclick="eXo.desktop.UIDockbar.showNavigation(event)"/><span class="Tooltip" style="display: none"><%=_ctx.appRes("UIPageDesktop.title.pageNavigation")%></span>
	                <%if(rcontext.getRemoteUser() == null) {%>
		                  <img id="SignInIcon" class="Icon" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/Signin.png"  alt="/eXoResources/skin/sharedImages/Blank.gif" title=""
		                         onclick="<%=uicomponent.event("ShowLoginForm", null);%>" /><span class="Tooltip" style="display: none;"><%=_ctx.appRes("UIPageDesktop.title.SignIn")%></span>
		                  <img class="Separator" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/background/Separator2x1.png"/>
                  <%}%>

                  <%if(modifiable) {%>
		                  <img class="Icon" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/AddPortlet.png"  alt="/eXoResources/skin/sharedImages/Blank.gif" title=""
		                       id="UIAddApplicationIcon"
		                       onclick="<%=uicomponent.event("ShowAddNewApplication")%>"/><span class="Tooltip" style="display: none"><%=_ctx.appRes("UIPageDesktop.title.AddApplication")%></span>
		                  <img class="Separator" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/background/Separator2x1.png"/>
                  <%}%>
                  <%                  
                    def res = rcontext.getApplicationResourceBundle() ;
                    String skin = rcontext.getUIApplication().getSkin() ;

                    for(uiChild in uicomponent.getChildren()) {
                      if(!(uiChild instanceof UIPortlet)) continue; 
                      String imgLocation = uiChild.getExoWindowID().getPortletApplicationName() + "/skin/DefaultSkin/portletIcons/" + uiChild.getExoWindowID().getPortletName() ;
                      
                    if(rcontext.getRemoteUser() != null) {
                  %>
                      <img id="DockItem${uiChild.id}" onmousedown="eXo.webui.UIRightClickPopupMenu.clickRightMouse(event, this, 'DockbarContextMenu', '${uiChild.id}', null, 1)" class="Icon" src="/${imgLocation}.png" alt="/eXoResources/skin/sharedImages/Blank.gif"
                           onerror="this.src='/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/DefaultPortlet.png'" onclick="eXo.desktop.UIDesktop.showHideWindow('UIWindow-${uiChild.id}', this);" /><span class="Tooltip" style="display: none"><%=uiChild.getTitle();%></span>
                  <%}else{%>
                  		<img id="DockItem${uiChild.id}" class="Icon" src="/${imgLocation}.png" alt="/eXoResources/skin/sharedImages/Blank.gif"
                           onerror="this.src='/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/DefaultPortlet.png'" onclick="eXo.desktop.UIDesktop.showHideWindow('UIWindow-${uiChild.id}', this);" /><span class="Tooltip" style="display: none"><%=uiChild.getTitle();%></span>
									<%}}%>
			
                  <img class="Separator" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/background/Separator2x1.png" />
                  <img id="PortletsViewer" class="Icon" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/ShowPortletsViewer.png"  alt="/eXoResources/skin/sharedImages/Blank.gif" title=""/><span class="Tooltip" style="display: none;"><%=_ctx.appRes("UIPageDesktop.title.ShowPortletDesktop")%></span>
                  <img id="WidgetsViewer" class="Icon" src="/eXoResources/skin/DefaultSkin/portal/webui/component/view/UIPageDesktop/icons/80x80/HideWidgetsViewer.png"  alt="/eXoResources/skin/sharedImages/Blank.gif" title=""/><span class="Tooltip" style="display: none;"><%=_ctx.appRes("UIPageDesktop.title.ShowWidgetDesktop")%></span>
                </div>
              </div>
            </div>
          </div>
        </div> 
      </div>
    </div>
  </div>
</div>

<%
  jsmanager.addOnLoadJavascript('eXo.desktop.UIDesktop.init');
  jsmanager.addOnResizeJavascript('eXo.desktop.UIDesktop.fixDesktop');
%>